## [01_02] 사례 소개

### 사례1. 데이터베이스 서버 한대가 디스크 성능 저하 이슈가 발생

#### 문제 발견(db팀)
- 1초 이상 걸리는 질의 로그
- 지난주 시간당 12번 이상 발생
- 특정 스토리지가 사용중임을 발견

#### 문제 분석(성능 분석팀)
- **USE 방법론 사용(Utilzation, Saturation, Error)**
  - 사용률: CPU, Network 사용률은 낮음, Disk 사용률이 높음
  - 포화도: Disk의 평균 I/O 지연시간 증가 -> 디스크 부하 문제 확인
  - 오류: Disk 오류는 없음
- **Disk I/O 지연 원인 분석**
  - 디스크 파편화?
    - 파일 시스템의 사용량은 30%
    - HDD에서 데이터가 분산되어 저장되는 경우
      - 보통 `70% 이상`에서 확인
  - **드릴다운 분석 방법**은 시간이 많이 소요
    - 파일 시스템을 한 단계씩 내려가면서 검증하는 방법
  - 파일 시스템 캐시
    - 적중률: 다른 시스템 97%, 문제 시스템 91%
      - 상대적으로 낮음
- **파일 시스템 캐시 크기 확인**
  - 해당 크기가 작을 경우, 적중률이 낮음
  - 캐시 크기 감소
  - 개발 중인 애플리케이션이 많은 메모리를 차지하는 것이 원인
- 파일 시스템 캐시와 메모리의 연관 관계?
  - memory = mem_used + mem_free
  - `mem_used = buffers/cache[used] + buffers/cache[free](mem:buffers + mem:cached)`
    - buffers/cache[used]: 여러 app들이 나누어 사용하는 공간
  - buffers/cache[free]
    - mem_free
      - 일정 정해진 공간
    - mem_buffers
      - 지연 쓰기. 쓰기 요청을 buffer 단위로 write
    - mem_cached
      - disk 내용을 app에 쓰기 위해서는 memory 로드 필요, 내용 유지
    - **메모리 상에 유지하는 공간**
  - 만약 `buffers/cache[used]` 공간이 커지게 되면 `buffers/cache[free]`의 공간이 작아짐
    - cache 내용이 적어지면서 I/O가 많이 발생

### 사례2: 연산 작업이 많은 새로운 기능 추가한 시스템의 성능 분석
- 부하 테스트 진행
  - **새로운 기능이나 버전을 출시하기 전**에 진행해야 함
  - 부하를 늘려가면서 특정 기간 동안 테스트
    - 요청을 초당 100개씩 늘려가면서 1분씩 테스트 진행
- 부하를 만들어낼 시뮬레이터
  - 자체 로드 테스트 도구를 재활용
  - `700 req/s` 제약이 존재(시뮬레이터 성능 제한)
- `700 req/s`에 대한 기존/신규 앱의 **CPU 사용량** 분석
  - 서버 cpu 사용률 `20% -> 30%`
- `700 req/s` 제한 원인
  - 시뮬레이터 자체 한계 이유 파악
  - 시뮬레이터 CPU 사용률: `100% -> 100%`
  - single thread로 제작된 것이 원인
- 성능 분석 결과
  - 신규 버전의 자원 사용량 확인 및 해당 자원 사용에 맞게 서버 자원 구성
  - 시뮬레이터 개선 등록