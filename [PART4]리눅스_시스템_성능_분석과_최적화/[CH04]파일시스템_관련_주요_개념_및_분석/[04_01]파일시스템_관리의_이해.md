## [04_01] 파일시스템 관리의 이해
- 파일 시스템 
  - Ubuntu 22.04 default fs: EXT4
  - Amazon Linux 2 default fs: XFS
- 페이지 캐시
  - 페이지 캐시의 일부가 **버퍼 캐시**로 사용됨

### 파일 시스템에 따른 성능 차이
- 동일한 머신에 대해 서로 다른 파일 시스템으로 테스트
  - F2FS, XFS, EXT4, Btrfs
- MariaDB
  - F2FS > XFS > EXT4 > Btrfs
- Flexible IO tester 벤치마크
  - XFS > EXT4 >>> F2FS >> Btrfs

#### 결과
- XFS, EXT4의 경우 성능 차이가 크지 않음
  - 다양한 **워크로드**에 이미 최적화
  - 일반적이지 않은 I/O Bound 워크로드를 제외하고는
  - 파일 시스템의 파일 I/O 성능 관련한 지배적인 요소는 아닌 경우가 많음
- 하지만 **커널 버전에 따른 성능 이슈**는 확인 필요
  - 여전히 관련 commit은 진행됨

### 페이지 캐시(읽기 성능 개선)
- 디스크 성능 개선은 **최대한 캐시**를 사용하도록 최적화
- 디스크 입출력을 최소화하기 위해
  - **디스크 접근**이 필요한 데이터를 **물리 메모리**에 저장
- 페이지 캐시의 크기는 **동적**으로 변함
  - 가용 메모리가 있는 경우 증가
  - 가용 메모리가 없는 경우 감소
- 페이지에 읽으려는 데이터가
  - 있는 경우: cache hit
  - 없는 경우: cache miss
- **캐시 히트 비율**에 따라 성능 크게 영향
  - 1 CPU Cycle을 1초로 계산 했을 때,
    - 메모리 접근 지연: 6min
    - 플래시 메모리 접근 지연: 2-6d
    - 하드 디스크 접근 지연시간: 1~12m

### 버퍼 캐시(쓰기 성능 개선)
- 지연 쓰기(비동기 쓰기)
  - 쓰기 동작은 **페이지 캐시**에 수행하고
  - 즉시 디스크에 내용을 갱신하지 않음
    - `dirty bit` 세팅
  - 주기적으로 **dirty page를 disk에 저장**
    - `pdflush` 데몬
  - buffer cache가 따로 존재하지 않음
    - Unified Page Cache
    - Page Cache의 일부를 나누어 사용
- 쓰기 요청이 많이 발생하는 상황에서
  - 읽기 요청에 사용되는 공간이 적어지면
  - 성능 저하가 발생하는가?
    - **pdflush**로 쓰기 캐시 공간을 제한 가능

### 동기적인 쓰기 동작
- 동기적인 쓰기 요청
  - `fsync(int fd)`
    - 특정 파일에 대한 모든 **지연된 쓰기 버퍼** 내용을
    - **동기적**으로 디스크에 저장
  - **파일 오픈시 동기화 옵션 사용**
    - `O_SYNC` 모드
      - `write + fsync` 요청
    - `O_DIRECT`
      - 버퍼 캐시를 사용하지 않고 바로 **디스크에 쓰기 수행**
- **굳이 페이지 캐시를 사용하지 않는 이유?**
  - e.g. `db`는 성능 및 안정성을 보장하기 위해, **자체 메모리 관리 기능**을 구현
- **더티 페이지**가 일정 비율 도달시
  - `vm.dirty_ratio`로 지정 가능
  - **모든 쓰기 요청** 중지
  - 동기적으로 **쓰기 페이지** flush 작업이 진행
    - **쓰기 성능 급격히 저하 발생**

### 정리
- 파일 시스템에 따른 성능
  - 일반적인 워크로드에서는 크게 차이가 나지 않음
  - I/O 동작이 중요한 워크로드(e.g. db)는 
    - **`fs`의 종류 + 커널 버전 확인**
- 캐시를 최대한 활용하여 디스크 접근을 최소화
  - **페이지 캐시 -> 읽기 성능 개선**
    - cache hit 비율에 따라 성능 영향
  - **버퍼 캐시 -> 쓰기 성능 개선**
    - 지연쓰기
    - 동기적 쓰기도 가능(e.g. `fsync, O_SYNC, O_DIRECT`)
    - 쓰기 요청이 급격히 증가할 경우, 동기적으로 쓰기 작업이 이루어질 수 있음
